!function(){"use strict";class t{constructor(t,e){this.lat=t,this.long=e}static getCoordinates(){return new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition(t,e)}))}static async getPosition(){let e;try{e=await t.getCoordinates()}catch{throw console.log("position wrong"),new Error}const{latitude:i,longitude:n}=e.coords;return console.log(`lat ${i}`),console.log(`long ${n}`),new t(i,n)}static coordsPattern=/([-+]?\d+\.\d+),\s*([-+]?\d+\.\d+)/;static checkCoords(e){let i,n;const o=e.match(t.coordsPattern);if(o)return i=o[1],n=o[2],new t(i,n);throw new Error("Wrong format coordinates. It must be: number, number")}}class e{constructor(t,e){this.id=Math.floor(performance.now()),this.content=t,this.date=Date.now(),this.type=e}}class i{constructor(t){this.postService=t}async add(t){const e=new Promise(((e,i)=>{this.postService.create(t,(t=>{console.log("inserted"),e(t)}))}));return await e}async filter(t,e){const i={filterName:t,filterValue:e},n=new Promise(((t,e)=>{this.postService.filter(i,(e=>{console.log("filtered"),t(e)}))}));return await n}}var n=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{url:url,sendMethod:sendMethod,method:method,id:id,data:data,callback:callback},e=`${t.url}/${t.method}`;t.id&&(e+=`&id=${t.id}`),"GET"===t.sendMethod?fetch(e).then((t=>t.json())).then((e=>{console.log(e),t.callback(e)})).catch((t=>{console.error(`Error: ${t}`)})):"POST"===t.sendMethod?fetch(e,{method:"POST",body:JSON.stringify(t.data),headers:{"Content-Type":"application/json"}}).then((t=>t.json())).then((e=>{console.log(e),t.callback(e)})).catch((t=>{console.error(`Error: ${t}`)})):"PUT"===t.sendMethod&&fetch(e,{method:"PUT",body:t.data}).then((t=>t.json())).then((e=>{console.log(e),t.callback(e)})).catch((t=>{console.error(`Error: ${t}`)}))};class o{constructor(t){this.url=t}async list(t){n({url:this.url,sendMethod:"GET",method:"allPosts",callback:t})}async get(t,e){n({url:this.url,sendMethod:"GET",method:"postById",id:t,callback:e})}async create(t,e){n({url:this.url,sendMethod:"POST",method:"createPost",data:t,callback:e})}async filter(t,e){n({url:this.url,sendMethod:"POST",method:"filterPosts",data:t,callback:e})}async upload(t,e){n({url:this.url,sendMethod:"PUT",method:"upload",data:t,callback:e})}}class s{constructor(t,e,i,n){this.postService=e,this.createPostShowAll=i,this.form=t,this.url=n,this.onAddFile=this.onAddFile.bind(this),this.onDropFile=this.onDropFile.bind(this)}bindToDOM(){this.fileInput=document.querySelector(".file-input"),this.fileContainer=document.querySelector(".file-container"),this.uploadForm=document.querySelector(".upload-form"),this.fileContainer.addEventListener("click",(t=>{this.fileInput.dispatchEvent(new MouseEvent("click"))})),this.fileInput.addEventListener("change",this.onAddFile),this.form.addEventListener("dragover",(t=>{t.preventDefault()})),this.form.addEventListener("drop",this.onDropFile)}onAddFile(t){console.dir(this.fileInput);const e=this.fileInput.files&&this.fileInput.files[0];let i;const n=new FormData(this.uploadForm);this.postService.upload(n,(t=>{console.log("uploaded"),i=`${this.url}${t}`,e.type.includes("image")?this.createPostShowAll(i,"img"):e.type.includes("video")?this.createPostShowAll(i,"vid"):e.type.includes("audio")&&this.createPostShowAll(i,"aud")}))}onDropFile(t){t.preventDefault();const e=t.dataTransfer.files&&t.dataTransfer.files[0];let i;this.fileInput.files=t.dataTransfer.files;const n=new FormData(this.uploadForm);this.postService.upload(n,(t=>{console.log("uploaded"),i=`${this.url}${t}`,e.type.includes("image")?this.createPostShowAll(i,"img"):e.type.includes("video")?this.createPostShowAll(i,"vid"):e.type.includes("audio")&&this.createPostShowAll(i,"aud")}))}}class r{constructor(t){const e=document.createElement("form");e.className="warning",e.name="warning",e.innerHTML=this.warningFormMarkup(),t.insertBefore(e,null),this.onWarningCancel=this.onWarningCancel.bind(this),this.onWarningSubmit=this.onWarningSubmit.bind(this)}warningFormMarkup(){return'\n        <form class="warning" name="warning">\n            <label for="warning-position">\n                We\'re sorry.\n                But something went wrong, we couldn\'t get your position.\n                Please allow access to your position or input your position \n                into field below in format: latitude, longitude.\n            </label>\n            <input type="text" class="warning-position" name="warning-position" id="warning-position">\n            <input type="submit" value="OK" class="warning__submit">\n            <input type="button" value="Cancel" class="warning__cancel">\n        </form>\n    '}bindToDOM(){this.warningForm=document.querySelector(".warning"),this.inputPosElem=this.warningForm.querySelector(".warning-position"),this.cancelBtn=this.warningForm.querySelector(".warning__cancel"),this.cancelBtn.addEventListener("click",this.onWarningCancel)}async showWarning(){this.warningForm.classList.toggle("warning_active");const t=new Promise(((t,e)=>{this.warningForm.addEventListener("submit",(e=>{const i=this.onWarningSubmit(e);t(i)}))}));return await t}onWarningSubmit(e){let i;e.preventDefault();const n=this.inputPosElem.value;try{i=t.checkCoords(n)}catch(t){throw console.log(t),alert(t),new Error(t)}return this.warningForm.remove(),i}onWarningCancel(t){this.inputPosElem.value="",this.warningForm.classList.toggle("warning_active")}}class a{constructor(t,e){this.sec=t,this.min=e}}class d{constructor(t,e,i,n){this.form=t,this.createPostShowAll=e,this.postService=i,this.url=n,this.onAddVideoSubmit=this.onAddVideoSubmit.bind(this),this.updateTimer=this.updateTimer.bind(this),this.onStopVideoAndHide=this.onStopVideoAndHide.bind(this),this.onCanPlay=this.onCanPlay.bind(this)}bindToDOM(){this.videoBtn=this.form.querySelector(".post-video"),this.videoPlayer=document.querySelector(".video"),this.videoControls=document.querySelector(".video-controls"),this.videoTimer=document.querySelector(".video-timer"),this.videoSaveBtn=document.querySelector(".video-save"),this.videoCancelBtn=document.querySelector(".video-cancel"),this.videoBtn.addEventListener("click",this.onAddVideoSubmit),this.videoSaveBtn.addEventListener("click",this.onStopVideoAndHide),this.videoCancelBtn.addEventListener("click",this.onStopVideoAndHide)}updateTimer(){59===this.timer.sec?(this.timer.min++,this.timer.sec=0):this.timer.sec++,this.videoTimer.textContent=`${this.timer.min.toString().padStart(2,"0")}:${this.timer.sec.toString().padStart(2,"0")}`}toggleVideoBlock(){this.videoPlayer.classList.toggle("video_active"),this.videoControls.classList.toggle("video-controls_active")}onStopVideoAndHide(t){"video-cancel"===t.target.className&&(this.cancelled=!0),this.recorder.stop(),this.stream.getTracks().forEach((t=>t.stop())),this.toggleVideoBlock(),this.videoBtn.classList.toggle("hidden")}onCanPlay(){this.timer=new a(0,0),this.videoIntervalId=setInterval(this.updateTimer,1e3),this.videoPlayer.play()}async onAddVideoSubmit(t){this.videoBtn.classList.toggle("hidden");const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});this.stream=e,this.videoPlayer.srcObject=e,this.videoPlayer.muted=!0,this.toggleVideoBlock(),this.videoPlayer.addEventListener("canplay",this.onCanPlay);const i=new MediaRecorder(e);this.recorder=i;const n=[];i.addEventListener("start",(()=>{console.log("start"),this.cancelled=!1})),i.addEventListener("dataavailable",(t=>{n.push(t.data)})),i.addEventListener("stop",(async()=>{if(this.videoIntervalId&&(clearInterval(this.videoIntervalId),this.videoPlayer.removeEventListener("canplay",this.onCanPlay)),!this.cancelled){const t=new Blob(n);let e;URL.createObjectURL(t),this.uploadVideoForm=document.querySelector(".video-form"),this.videoFileInput=document.querySelector(".video-file-input");const i=new File([t],"tmpFile",{type:t.type}),o=new DataTransfer;o.items.add(i),this.videoFileInput.files=o.files;const s=new FormData(this.uploadVideoForm);this.postService.upload(s,(t=>{console.log("uploaded"),e=`${this.url}${t}`,this.createPostShowAll(e,"vid")}))}})),i.start()}}const l=new class{constructor(t){this.urlServer="https://ahj-diploma-backend.onrender.com",this.containerName=t,this.postService=new o(this.urlServer),this.postList=new i(this.postService),this.onAddSubmit=this.onAddSubmit.bind(this),this.onAddLocation=this.onAddLocation.bind(this),this.onSearchSubmit=this.onSearchSubmit.bind(this),this.onFilter=this.onFilter.bind(this),this.onClearFilter=this.onClearFilter.bind(this)}addFormMarkup(){return'\n        <form class="create-post" name="create-post">\n            <input type="text" class="post-text" name="post-text"> \n            <span class="post-video material-icons">videocam</span>\n        </form>\n        <div class="buttons">\n          <form class="upload-form"> \n            <span class="location-btn material-symbols-outlined">location_on</span>\n            <div class="file-container">\n              <input class="overlapped file-input" name="file" type="file" accept="image, video, audio">\n              <span class="file-btn material-symbols-outlined">note_stack_add</span>\n            </div>\n          </form>\n        </div>\n        '}bindToDOM(){this.container=document.querySelector(this.containerName)}bindToDOMAdd(){this.form=document.querySelector(".create-post"),this.inputElem=this.form.querySelector(".post-text"),this.locationBtn=document.querySelector(".location-btn"),this.searchInput=document.querySelector(".search-input"),this.searchForm=document.querySelector(".search-form"),this.searchBtn=document.querySelector(".search-icon"),this.filterElem=document.querySelector(".filter-attach"),this.filterClear=document.querySelector(".filter_all"),this.form.addEventListener("submit",this.onAddSubmit),this.locationBtn.addEventListener("click",this.onAddLocation),this.searchForm.addEventListener("submit",this.onSearchSubmit),this.searchBtn.addEventListener("click",this.onSearchSubmit),this.filterElem.addEventListener("click",this.onFilter),this.filterClear.addEventListener("click",this.onClearFilter)}renderPost(t){const e=new Date(t.date);return"video"===t.type?`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              <video class="${t.content.className}" src="${t.content.src}" controls>\n              </video>\n            </div>\n        </div>\n    `:"url"===t.type?`\n          <div class="post" data-id="${t.id}">\n              <div class="post__date">\n                ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n              </div>\n              <div class="post__content">\n                <a href="${t.content}">${t.content}</a>\n              </div>\n          </div>\n      `:"loc"===t.type?`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              [${t.content.lat}, ${t.content.long}]\n            </div>\n        </div>\n    `:"img"===t.type?`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              <a download href="${t.content}" rel="noopener" name="abc">\n                <img class="post__img" src="${t.content}">\n              </a>\n            </div>\n        </div>\n    `:"vid"===t.type?`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              <video class="video-post" controls src="${t.content}"></video>\n            </div>\n        </div>\n    `:"aud"===t.type?`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              <audio controls src="${t.content}"></audio>\n            </div>\n        </div>\n    `:`\n        <div class="post" data-id="${t.id}">\n            <div class="post__date">\n              ${e.getDate().toString().padStart(2,"0")}.${e.getMonth().toString().padStart(2,"0")}.${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}\n            </div>\n            <div class="post__content">\n              ${t.content}\n            </div>\n        </div>\n    `}renderPosts(){const t=document.createElement("div");t.className="post-container",this.container.insertBefore(t,this.form),this.postService.list((e=>{e.forEach((e=>{const i=this.renderPost(e);t.insertAdjacentHTML("beforeend",i)})),this.postContainer=t,setTimeout((()=>{this.container.scrollTop=this.container.scrollHeight}),100)}))}renderContent(){this.renderPosts();const t=document.createElement("form");t.className="create-post",t.name="create-post",t.innerHTML=this.addFormMarkup(),this.container.insertBefore(t,null),this.bindToDOMAdd(),this.warningShow=new r(this.container),this.warningShow.bindToDOM(),this.fileUploader=new s(this.form,this.postService,this.createPostShowAll.bind(this),this.urlServer),this.fileUploader.bindToDOM(),this.videoRec=new d(this.form,this.createPostShowAll.bind(this),this.postService,this.urlServer),this.videoRec.bindToDOM()}clearPosts(){Array.from(this.postContainer.querySelectorAll(".post")).forEach((t=>{t.remove()}))}updatePosts(t){t?t.forEach((t=>{const e=this.renderPost(t);this.postContainer.insertAdjacentHTML("beforeend",e)})):this.postService.list((t=>{t.forEach((t=>{const e=this.renderPost(t);this.postContainer.insertAdjacentHTML("beforeend",e)}))})),setTimeout((()=>{this.container.scrollTop=this.container.scrollHeight}),100)}async createPostShowAll(t,i){const n=new e(t,i),o=await this.postList.add(n);this.inputElem.value="",this.clearPosts(),this.updatePosts(o)}onAddSubmit(t){t.preventDefault();const e=this.inputElem.value.trim();this.isValidURL(e)?this.createPostShowAll(e,"url"):this.createPostShowAll(e,"text")}isValidURL(t){return!!/^(http(s)?:\/\/.)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/=]*)$/g.test(t)}async onAddLocation(e){let i;e.preventDefault();try{i=await t.getPosition()}catch{i=await this.warningShow.showWarning()}this.createPostShowAll(i,"loc")}async onSearchSubmit(t){t.preventDefault();const e=this.searchInput.value.trim();e?this.postList.filter("content",e).then((t=>{this.clearPosts(),this.updatePosts(t)})):(this.clearPosts(),this.updatePosts())}async onFilter(t){t.target.classList.contains("filter_img")?this.postList.filter("type","img").then((t=>{this.clearPosts(),this.updatePosts(t)})):t.target.classList.contains("filter_video")?this.postList.filter("type","vid").then((t=>{this.clearPosts(),this.updatePosts(t)})):t.target.classList.contains("filter_audio")&&this.postList.filter("type","aud").then((t=>{this.clearPosts(),this.updatePosts(t)}))}onClearFilter(t){this.clearPosts(),this.updatePosts()}}(".container");l.bindToDOM(),l.renderContent()}();